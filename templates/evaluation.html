<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluation Progress</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container mt-4">
        <div class="card panel">
            <div class="card-header">
                <h1>üîç Evaluation Progress</h1>
                <p class="mb-0">Analyzing clips for cheating detection</p>
            </div>
            <div class="card-body">
                <a href="/" class="btn btn-secondary mb-3">‚Üê Back to Main</a>

                <div class="card panel mb-3">
                    <div class="card-header">
                        <h3>Evaluation Configuration</h3>
                    </div>
                    <div class="card-body">
                        <p><strong>Model:</strong> {{ model_name }}</p>
                        <p><strong>Data Path:</strong> {{ data_path }}</p>
                        <p><strong>Process ID:</strong> {{ process_id }}</p>
                        <p><strong>Started:</strong> <span id="start-time">{{ start_time }}</span></p>
                    </div>
                </div>

                <div class="card panel">
                    <div class="card-body">
                        <div id="status" class="alert alert-info">üîÑ Evaluation in progress...</div>
                        <div class="progress mb-2">
                            <div id="progress-fill" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div id="progress-text">Starting evaluation...</div>
                    </div>
                </div>

                <div class="log-container mt-3">
                    <div id="logs">Connecting to evaluation stream...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='main.js') }}"></script>
    <script>
        const processId = '{{ process_id }}';
        const eventSource = new EventSource(`/stream-evaluation/${processId}`);
        const logsDiv = document.getElementById('logs');
        const statusDiv = document.getElementById('status');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');
        const logContainer = document.getElementById('log-container');

        let logLines = [];

        eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);

            if (data.type === 'log') {
                logLines.push(data.content);
                logsDiv.innerHTML = logLines.join('<br>');
                logContainer.scrollTop = logContainer.scrollHeight;

                // Update progress text
                progressText.textContent = data.content;

                // Simple progress estimation based on log content
                let progress = 0;
                if (data.content.includes('Loading model')) {
                    progress = 20;
                } else if (data.content.includes('DataLoader')) {
                    progress = 40;
                } else if (data.content.includes('Start evaluation')) {
                    progress = 60;
                } else if (data.content.includes('evaluating')) {
                    progress = 80;
                }
                progressFill.style.width = progress + '%';
                progressFill.setAttribute('aria-valuenow', progress);

            } else if (data.type === 'results_ready') {
                // Show results are ready with button to view detailed analysis
                const resultsButton = document.createElement('div');
                resultsButton.innerHTML = `
                    <div class="alert alert-success mt-3">
                        <h4 class="alert-heading">üìä Detailed Results Ready!</h4>
                        <p>Comprehensive analysis of ${data.total_clips} clips is complete.</p>
                        <hr>
                        <a href="/evaluation-results/${data.process_id}" class="btn btn-primary">
                           View Detailed Results ‚Üí
                        </a>
                    </div>
                `;
                document.querySelector('.card-body').appendChild(resultsButton);
                progressFill.style.width = '95%';
                progressFill.setAttribute('aria-valuenow', 95);

            } else if (data.type === 'status') {
                if (data.status === 'completed') {
                    statusDiv.className = 'alert alert-success';
                    statusDiv.innerHTML = '‚úÖ Evaluation completed successfully!';
                    progressFill.style.width = '100%';
                    progressFill.setAttribute('aria-valuenow', 100);
                    progressText.textContent = 'Evaluation finished';
                    eventSource.close();
                } else if (data.status === 'error') {
                    statusDiv.className = 'alert alert-danger';
                    statusDiv.innerHTML = '‚ùå Evaluation failed';
                    progressText.textContent = 'Evaluation failed';
                    eventSource.close();
                }
            }
        };

        eventSource.onerror = function(event) {
            console.log('EventSource failed:', event);
            statusDiv.className = 'alert alert-danger';
            statusDiv.innerHTML = '‚ùå Connection lost';
            progressText.textContent = 'Connection error';
            eventSource.close();
        };

        // Auto-scroll logs
        const observer = new MutationObserver(function(mutations) {
            logContainer.scrollTop = logContainer.scrollHeight;
        });

        observer.observe(logsDiv, {
            childList: true,
            subtree: true,
            characterData: true
        });
    </script>
</body>
</html>
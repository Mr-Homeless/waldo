<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Clip Analysis - {{ clip.clip_name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  </head>
  <body>

    <!-- Frame Modal -->
    <div id="frameModal" class="modal" style="display: none;">
        <span class="modal-close" onclick="closeFrameModal()">&times;</span>
        <img class="modal-content" id="modalImage">
        <div class="modal-caption" id="modalCaption"></div>
    </div>

    <div class="container mt-4">
        <div class="text-center mb-4">
            <h1 class="display-4">Clip Analysis</h1>
            <h2>{{ clip.clip_name }}</h2>
        </div>

        <a href="/evaluation-results/{{ process_id }}" class="btn btn-secondary mb-4">← Back to Results</a>

        <div class="row g-4">
            <div class="col-lg-6">
                <div class="card panel h-100">
                    <div class="card-body">
                        <h3 class="card-title">Video Playback</h3>
                        <div class="video-container text-center my-3">
                            <video controls class="w-100 rounded shadow-sm">
                                <source src="/serve-video/{{ process_id }}/{{ clip.id }}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        </div>
                        <div class="alert alert-info">
                            <strong>Video Information:</strong><br>
                            • Original file: {{ clip.filename }}<br>
                            • This is the exact clip analyzed by the model.
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card panel h-100">
                    <div class="card-body">
                        <h3 class="card-title">Model Prediction</h3>
                        <div class="text-center p-3 my-3 rounded" style="background-color: {{ clip.confidence.color }}; color: white;">
                            <div style="font-size: 3rem; font-weight: bold;">{{ "%.3f"|format(clip.normalized_score) }}</div>
                            <div>{{ clip.confidence.category }}</div>
                            <small>{{ clip.confidence.label }}</small>
                        </div>
                        <div class="progress mb-3">
                            <div class="progress-bar" role="progressbar" style="width: {{ (clip.normalized_score * 100)|round }}%; background-color: {{ clip.confidence.color }};" aria-valuenow="{{ (clip.normalized_score * 100)|round }}" aria-valuemin="0" aria-valuemax="100">{{ (clip.normalized_score * 100)|round }}%</div>
                        </div>
                        <div class="alert alert-light border">
                            <strong>Probability Estimate:</strong> {{ "%.1f"|format(clip.probability * 100) }}%
                            <div class="font-monospace small text-muted mt-1">P = 1 / (1 + e^(-logit))</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card panel mt-4">
            <div class="card-body">
                <h3 class="card-title">Technical Analysis</h3>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center">Clip ID: <span>#{{ clip.id + 1 }}</span></li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">Normalized Score: <span class="font-monospace">{{ "%.6f"|format(clip.normalized_score) }}</span></li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">Estimated Probability: <span class="font-monospace">{{ "%.4f"|format(clip.probability) }} ({{ "%.1f"|format(clip.probability * 100) }}%)</span></li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">Confidence Level: <span>{{ clip.confidence.level }}/5</span></li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">Category: <span style="color: {{ clip.confidence.color }};">{{ clip.confidence.category }}</span></li>
                    <li class="list-group-item d-flex justify-content-between align-items-center text-break">File Path: <span class="font-monospace small">{{ clip.video_path }}</span></li>
                </ul>
            </div>
        </div>

        {% if clip.frame_paths and clip.frame_paths|length > 0 %}
        <div class="card panel mt-4">
            <div class="card-body">
                <h3 class="card-title">Analyzed Frames</h3>
                <p class="text-muted">These are the 16 frames analyzed by the model, extracted from the killshot moment with an adaptive center crop.</p>
                <div class="row row-cols-4 row-cols-md-8 g-2">
                    {% for i in range(clip.frame_paths|length) %}
                    <div class="col">
                        <div class="frame-container">
                            <img src="/serve-frame/{{ process_id }}/{{ clip.id }}/{{ i }}" alt="Frame {{ i + 1 }}" class="img-fluid rounded border" style="cursor: pointer;" onclick="showFrameModal('/serve-frame/{{ process_id }}/{{ clip.id }}/{{ i }}', {{ i + 1 }})">
                            <div class="small text-muted text-center mt-1">{{ "%.2f"|format((i / 15.0)) }}s</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <div class="card panel mt-4">
            <div class="card-body">
                <h3 class="card-title">Score Interpretation Guide</h3>
                <div class="row g-2 text-center text-white">
                    <div class="col" style="background-color: #dc3545; padding: 10px; border-radius: 5px;"><strong>0.8-1.0</strong><br><small>Very High</small></div>
                    <div class="col" style="background-color: #fd7e14; padding: 10px; border-radius: 5px;"><strong>0.6-0.8</strong><br><small>High</small></div>
                    <div class="col" style="background-color: #ffc107; padding: 10px; border-radius: 5px; color: #212529 !important;"><strong>0.4-0.6</strong><br><small>Medium</small></div>
                    <div class="col" style="background-color: #20c997; padding: 10px; border-radius: 5px;"><strong>0.2-0.4</strong><br><small>Low</small></div>
                    <div class="col" style="background-color: #28a745; padding: 10px; border-radius: 5px;"><strong>0.0-0.2</strong><br><small>Very Low</small></div>
                </div>
            </div>
        </div>

        <div class="alert alert-warning mt-4">
            <strong>Important Note:</strong> Model predictions are not definitive proof. Always use these results as guidance, not absolute truth.
        </div>

        <div class="card panel mt-4">
            <div class="card-body">
                <h3 class="card-title">Model Information</h3>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center">Architecture: <span>Vision Transformer (ViT)</span></li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">Model Size: <span>vit_giant_patch14_224</span></li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">Analysis Time: <span>{{ metadata.evaluation_timestamp[:19].replace('T', ' ') }}</span></li>
                    <li class="list-group-item d-flex justify-content-between align-items-center text-break">Model Path: <span class="font-monospace small">{{ metadata.model_path }}</span></li>
                </ul>
            </div>
        </div>

    </div>

    
    <script>
        function showFrameModal(src, frameNumber) {
            const modal = document.getElementById('frameModal');
            const modalImg = document.getElementById('modalImage');
            const captionText = document.getElementById('modalCaption');
            modal.style.display = "block";
            modalImg.src = src;
            captionText.innerHTML = `Frame ${frameNumber} of 16`;
        }

        function closeFrameModal() {
            document.getElementById('frameModal').style.display = "none";
        }

        window.onclick = function(event) {
            const modal = document.getElementById('frameModal');
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    </script>
  </body>
</html>
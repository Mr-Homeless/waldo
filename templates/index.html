<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>WALD01 - CS2 Cheat Detection</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  </head>
  <body>
    <div class="container-fluid">
        <div class="text-center mb-4">
            <h1>WALD01 - CS2 Cheat Detection</h1>
            <p class="mb-3">A simple interface for training and using the CS2 cheat detection model.</p>
            <a href="/evaluations" class="btn btn-primary squishy">View Saved Evaluations</a>
        </div>

        <div id="message-display"></div>

        <div class="row">
                    <!-- Auto-Edit Section -->
                    <div class="col-lg-4 mb-4">
                        <div class="card panel h-100">
                            <div class="card-header"><h3>1. Process Raw Footage</h3></div>
                            <div class="card-body d-flex flex-column">
                                <form id="process-form" action="/process" method="post" enctype="multipart/form-data">
                                    <div class="form-group">
                                        <label for="videoFile">Select a raw video file:</label>
                                        <div class="custom-file">
                                            <input type="file" class="custom-file-input" id="videoFile" name="videoFile" accept=".mp4,.mov,.avi" required>
                                            <label class="custom-file-label" for="videoFile">Choose file...</label>
                                        </div>
                                        <small class="form-text text-muted">Your CS2 gameplay recording with clear audio.</small>
                                    </div>
                                    <p class="text-muted small mt-3">Upload a CS2 gameplay video to automatically extract 2-second clips around detected kills.</p>
                                    <div class="mt-auto">
                                        <button id="process-button" type="submit" class="btn btn-primary btn-block squishy mt-4">
                                            <span id="process-spinner" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                                            <span id="process-button-text">Process Video</span>
                                        </button>
                                        <small id="processing-message" class="form-text text-muted text-center mt-2" style="display: none;">Processing... this may take a while.</small>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Training Section -->
                    <div class="col-lg-4 mb-4">
                        <div class="card panel h-100">
                            <div class="card-header"><h3>2. Train or Fine-Tune</h3></div>
                            <div class="card-body d-flex flex-column">
                                <form action="/train" method="post">
                                    <div class="form-group">
                                        <label for="clipsDirectory">Select directory of processed clips:</label>
                                        <select class="form-control" id="clipsDirectory" name="clipsDirectory" required>
                                            {% for clip_dir in processed_clips %}
                                                <option value="{{ clip_dir }}">{{ clip_dir }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Training Type:</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="trainingType" id="trainNew" value="new" checked>
                                            <label class="form-check-label" for="trainNew">Train a new model</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="trainingType" id="fineTune" value="finetune">
                                            <label class="form-check-label" for="fineTune">Fine-tune an existing model</label>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="modelType">Label clips as:</label>
                                        <select class="form-control" id="modelType" name="modelType" required>
                                            <option value="cheater">Cheater</option>
                                            <option value="not-cheater">Not Cheater</option>
                                        </select>
                                    </div>
                                    <div class="form-group" id="existing-model-selector" style="display: none;">
                                        <label for="existingModel">Select model to fine-tune:</label>
                                        <select class="form-control" id="existingModel" name="existingModel">
                                            {% for model in existing_models %}
                                                <option value="{{ model.path }}">{{ model.display_name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="mt-auto">
                                        <button type="submit" class="btn btn-primary btn-block squishy mt-4">Start Training</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Evaluation Section -->
                    <div class="col-lg-4 mb-4">
                        <div class="card panel h-100">
                            <div class="card-header"><h3>3. Test Clips for Cheating</h3></div>
                            <div class="card-body d-flex flex-column">
                                <form action="/evaluate" method="post">
                                    <div class="form-group">
                                        <label for="evalClipsDirectory">Select directory of clips to evaluate:</label>
                                        <select class="form-control" id="evalClipsDirectory" name="clipsDirectory" required>
                                            {% for clip_dir in processed_clips %}
                                                <option value="{{ clip_dir }}">{{ clip_dir }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="evalModel">Select model for evaluation:</label>
                                        <select class="form-control" id="evalModel" name="model" required>
                                            {% for model in existing_models %}
                                                <option value="{{ model.path }}">{{ model.display_name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="mt-auto">
                                        <button type="submit" class="btn btn-primary btn-block squishy mt-4">Evaluate Clips</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    
    <script>
        // Show/hide the existing model selector based on the training type
        const trainingTypeRadios = document.querySelectorAll('input[name="trainingType"]');
        const existingModelSelector = document.getElementById('existing-model-selector');

        trainingTypeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'finetune') {
                    existingModelSelector.style.display = 'block';
                } else {
                    existingModelSelector.style.display = 'none';
                }
            });
        });

        // --- Loading indicator for video processing ---
        const processForm = document.getElementById('process-form');
        const processButton = document.getElementById('process-button');
        const processSpinner = document.getElementById('process-spinner');
        const processButtonText = document.getElementById('process-button-text');
        const processingMessage = document.getElementById('processing-message');
        const videoFileInput = document.getElementById('videoFile');

        // File size display (no validation)
        videoFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const fileName = file.name;
                const nextSibling = e.target.nextElementSibling;
                nextSibling.innerText = fileName;
            }
        });

        processForm.addEventListener('submit', (e) => {
            const file = videoFileInput.files[0];
            if (!file) {
                e.preventDefault();
                alert('Please select a video file first.');
                return;
            }
            
            // Disable button and show spinner
            processButton.disabled = true;
            processSpinner.style.display = 'inline-block';
            processButtonText.textContent = 'Processing...';
            processingMessage.style.display = 'block';
        });
    </script>
  </body>
</html>
